{%extends 'base.html'%}
{%block header%}
<script>
	function total() {

		// 循环计算每个商品的小计
		shop_total = 0
		$('.cart_list_td').each(function () {
			price = parseFloat($(this).children('.col05').text());
			count = parseInt($(this).find('.num_show').val());
			var total = price*count;
			// 如果当前复选框为勾选时
			if($(this).find(':checkbox').prop('checked')){
			    shop_total+=total;
			}
			$(this).children('.col07').text(total.toFixed(2))
        })
		//通过测有几个ul来，给其赋值
		$('.total_count').text($('.cart_list_td').length);
		//总金额
		$('.settlements em').text(shop_total.toFixed(2));
		//勾选完商品计数			 	所有的checked，排除id=checked_all的
		$('.settlements b').text($(':checked:not(#checked_all)').length);
    };

	function del(id) {
	    //删除功能，传入当前的商品id，在数据库中删除，然后回调移除UL
		$.get('/cart/del/',{'id':id},function (data) {
			if(data.ok){
			    $('#'+id).remove()
				total()
			}
        })
    }


    $(function () {
		total()
		//全选全消
		$('#checked_all').click(function () {
			// 1.获取除了全选的复选框的其他checked属性
			//2 . 更改属性 3.执行计算函数
			var checked =$(this).prop('checked')
			$(':checkbox:not(#checked_all)').prop('checked',checked)
			total()
        });

		// 勾选checked 取消checked_all
		$(':checkbox:not(#checked_all)').click(function () {
			//判断 当前的勾选的数量是否和复选框的数量相等，相等则为全选，反之则取消全选
			var count = $(':checkbox:not(#checked_all)').length
		    var result = $(':checked:not(#checked_all)').length
        	if(count == result ){
			    $('#checked_all').prop('checked',true)
			}else {
				$('#checked_all').prop('checked',false)
			}
			total()
		});

		//修改数量
		$('.num_show').blur(function () {
		    var num = parseInt($(this).val())
			var kucun = parseInt($(this).parents('.col06').siblings('.col03').children('em').text())
			if(num < 1){
		        num = 1;
			}
			else if(num > kucun){
			    num=kucun;
			}
			else if(isNaN(num)){
			    num = 1;
			}
			//赋值，并修改数据库数量和总价
			$(this).val(num);
			// 获得当前商品所在购物车的id值
			var id=$(this).parents('ul').prop('id')
			$.get('/cart/edit/',{'id':id,'num':num},function (data) {
			    // 修改成功后，计算价格
				if(data.ok){
				    total()
				}
            })
        });

		$('.add').click(function () {
			//加
			var num  = parseInt($(this).next().val())
			num++;
			$(this).next().val(num).blur()
        });

		$('.minus').click(function () {
			//加
			var num  = parseInt($(this).prev().val())
			num--;
			$(this).prev().val(num).blur()
        });

    })


</script>
{%endblock header%}

{%block body%}
	<div class="total_count">全部商品<em></em>件</div>
	<ul class="cart_list_th clearfix">
		<li class="col01">商品名称</li>
		<li class="col02">商品单位</li>
		<li class="col03">商品价格</li>
		<li class="col04">数量</li>
		<li class="col05">小计</li>
		<li class="col06">操作</li>
	</ul>

<!--新增表单目的为了将呈现给页面上的数据传递到视图中去-->
<form method="post" action="/cart/order/">
	{%csrf_token%}
	{% for g in ug_list%}
	<ul class="cart_list_td clearfix" id="{{g.id}}">
												<!--为了给订单页传递对应商品的购物车id-->
		<li class="col01"><input type="checkbox" name="cartid" value="{{g.id}}" checked="checked"></li>
		<li class="col02"><img src="/static/{{g.goods_id.gpic}}"></li>
		<li class="col03">{{g.goods_id.gtitle}}<br><em>{{g.goods_id.gkucun}}</em></li>
		<li class="col04">{{g.goods_id.gunit}}</li>
		<li class="col05">{{g.goods_id.gprice}}元</li>
		<li class="col06">
			<div class="num_add">
				<a href="javascript:;" class="add fl">+</a>
				<input type="text" class="num_show fl" value="1">	
				<a href="javascript:;" class="minus fl">-</a>	
			</div>
		</li>
		<li class="col07">0</li>
		<li class="col08"><a href="javascript:del({{g.id}});">删除</a></li>
	</ul>
	{%endfor%}
	<ul class="settlements">
		<li class="col01"><input type="checkbox" id="checked_all" checked="checked"></li>
		<li class="col02">全选</li>
		<li class="col03">合计(不含运费)：<span>¥</span><em></em><br>共计<b></b>件商品</li>
							<!--改变了原有的设计标签，为了更方便的传递数据，记得改对应的css-->
		<li class="col04"><input type="submit" value="结算"></li>
	</ul>
</form>
{%endblock body%}
